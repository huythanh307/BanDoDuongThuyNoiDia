<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒë·ªì ƒë∆∞·ªùng th·ªßy n·ªôi ƒë·ªãa TP.ƒê√† N·∫µng</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* Nh√≥m c√°c n√∫t ƒëi·ªÅu khi·ªÉn */
        .controls-container {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .locate-button,
        .share-button {
            background: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4);
            font-weight: bold;
            border: none;
            width: 100%;
        }

        .share-button {
            background: #4CAF50;
            color: white;
        }

        .info-popup {
            min-width: 120px;
        }

        .info-popup h3 {
            margin: 0 0 10px 0;
            color: #d35400;
            border-bottom: 2px solid #f39c12;
        }

        .info-popup table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-popup td {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 10px;
        }

        .info-popup td:first-child {
            font-weight: bold;
            color: #555;
        }

        .leaflet-control-layers-toggle:after {
            content: "Ch·ªçn lo·∫°i b·∫£n ƒë·ªì";
            color: #333;
            font-weight: bold;
            font-size: 14px;
            padding-left: 30px;
            line-height: 36px;
            white-space: nowrap;
        }

        .leaflet-control-layers-toggle {
            width: auto !important;
            height: 36px !important;
            padding: 0 10px;
            background-position: 5px center !important;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .road-label {
            background: none;
            color: rgb(252, 2, 2);
            padding: 2px 8px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            border: none;
            text-align: center;
            text-shadow: #eee 2px 2px 4px;
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* B·∫£ng ch·ªçn file DTNDQN */
        .file-selector-panel {
            position: absolute;
            bottom: 10px;
            left: 20px;
            background: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 999;
            max-height: 70vh;
            overflow-y: auto;
            max-width: 260px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }

        .file-selector-panel .file-group {
            transition: max-height 0.3s ease;
            max-height: 600px;
            order: -1;
            margin-bottom: 12px;
            max-height: 45vh;
        }

        .file-selector-panel.collapsed .file-group {
            display: none;
        }

        .file-selector-panel.collapsed .btn-group {
            display: none;
        }

        .file-selector-panel h3 {
            margin: 0;
            color: #333;
            font-size: 12px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 6px;
            position: relative;
            padding: 0 30px 6px 0;
            line-height: 1.2;
            overflow: hidden;
        }

        /* T·ªëi ∆∞u ho√° cho ƒëi·ªán tho·∫°i */
        @media (max-width: 768px) {
            .file-selector-panel {
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-height: 50vh;
                min-width: auto;
                width: auto;
            }

            .file-selector-panel h3 {
                font-size: 13px;
                margin: 0;
                padding: 0 32px 6px 0;
            }

            .file-selector-panel .file-group {
                max-height: 30vh;
                margin-bottom: 8px;
            }
        }

        .close-panel-btn {
            left: 0;
            top: 50%;
            background: #269ff0;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .close-panel-btn:hover {
            background-color: #da190b;
        }

        .file-selector-panel .file-group label {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 12px;
        }

        .file-selector-panel .file-group label:hover {
            background-color: #f0f0f0;
        }

        .file-selector-panel input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .file-selector-panel .file-name {
            font-size: 13px;
            color: #555;
            flex: 1;
        }

        .file-selector-panel .btn-group {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            border-top: 1px solid #ddd;
            padding-top: 8px;
        }

        .file-selector-panel button {
            flex: 1;
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            font-size: 11px;
        }

        .file-selector-panel .btn-load {
            background-color: #4CAF50;
            color: white;
        }

        .file-selector-panel .btn-load:hover {
            background-color: #45a049;
        }

        .file-selector-panel .btn-clear {
            background-color: #f44336;
            color: white;
        }

        .file-selector-panel .btn-clear:hover {
            background-color: #da190b;
        }
    </style>
</head>

<body>
    <div class="file-selector-panel">
        <h3><button class="close-panel-btn" onclick="togglePanel()">‚úï</button> üìäCh·ªçn s√¥ng ƒë·ªÉ hi·ªÉn th·ªã
        </h3>
        <div class="file-group" id="fileCheckboxes"></div>
    </div>

    <div class="controls-container">
        <button class="locate-button" onclick="findMyState()">üìç V·ªã tr√≠ c·ªßa t√¥i</button>
        <button class="share-button" onclick="shareLocation()">üîó Chia s·∫ª v·ªã tr√≠ c·ªßa t√¥i</button>
    </div>

    <div id="map"></div>

    <script>
        // ==================== H√ÄM QU·∫¢N L√ù B·∫¢NG CH·ªåN S√îNG ====================

        // H√†m b·∫≠t/t·∫Øt hi·ªÉn th·ªã danh s√°ch s√¥ng
        function togglePanel() {
            const panel = document.querySelector('.file-selector-panel');
            const btn = document.querySelector('.close-panel-btn');
            panel.classList.toggle('collapsed');

            // ƒê·ªïi icon n√∫t ƒë·ªÉ ch·ªâ tr·∫°ng th√°i hi·ªÉn th·ªã/·∫©n
            if (panel.classList.contains('collapsed')) {
                btn.textContent = '‚ñº'; // M≈©i t√™n h∆∞·ªõng xu·ªëng - danh s√°ch ƒë√£ ·∫©n
            } else {
                btn.textContent = '‚úï'; // D·∫•u X - danh s√°ch ƒëang hi·ªÉn th·ªã
            }
        }

        // ==================== KH·ªûI T·∫†O B·∫¢N ƒê·ªí LEAFLET ====================
        var map = L.map('map', { center: [16.0544, 108.2022], zoom: 11 });
        var currentUserPos = null; // L∆∞u v·ªã tr√≠ GPS c·ªßa ng∆∞·ªùi d√πng ƒë·ªÉ chia s·∫ª
        var dtndqnLayers = {}; // L∆∞u tr·ªØ c√°c l·ªõp ƒë∆∞·ªùng th·ªßy ƒë√£ load
        var loadedFiles = {}; // Tracking c√°c file GeoJSON ƒë√£ ƒë∆∞·ª£c t·∫£i

        // ==================== DANH S√ÅCH ƒê∆Ø·ªúNG TH·ª¶Y ====================
        // Danh s√°ch c√°c file GeoJSON ƒë∆∞·ªùng th·ªßy n·ªôi ƒë·ªãa v·ªõi m√†u s·∫Øc ri√™ng
        const dtndqnFiles = [
            { name: 'C√π Lao Ch√†m', file: 'DTNDQN-CuLaoCham.geojson', color: '#FF6B6B' },
            { name: 'Bi·ªÉn b√°o', file: 'DTNDQN-Layer-BienBao.geojson', color: '#4ECDC4' },
            { name: 'S√¥ng C·ªï C√≤ - Qu·∫£ng Nam', file: 'DTNDQN-SongCoCo-QN.geojson', color: '#45B7D1' },
            { name: 'S√¥ng Tam K·ª≥', file: 'DTNDQN-SongTamKy.geojson', color: '#96CEB4' },
            { name: 'S√¥ng Tr∆∞·ªùng Giang', file: 'DTNDQN-SongTruongGiang.geojson', color: '#FFEAA7' },
            { name: 'S√¥ng V√µ Gia', file: 'DTNDQN-SongVuGia.geojson', color: '#DDA0DD' },
            { name: 'S√¥ng Y√™n', file: 'DTNDQN-SongYen.geojson', color: '#87CEEB' }
        ];

        // ==================== KH·ªûI T·∫†O GIAO DI·ªÜN CH·ªåN S√îNG ====================
        // T·∫°o danh s√°ch checkbox cho ph√©p ng∆∞·ªùi d√πng ch·ªçn c√°c s√¥ng ƒë·ªÉ hi·ªÉn th·ªã
        function initFileSelector() {
            const container = document.getElementById('fileCheckboxes');
            // Tr√°nh t·∫°o duplicate checkbox n·∫øu h√†m ƒë∆∞·ª£c g·ªçi nhi·ªÅu l·∫ßn
            if (container.children.length > 0) return;

            dtndqnFiles.forEach((file, index) => {
                // T·∫°o label ch·ª©a checkbox + t√™n s√¥ng
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = file.file;
                checkbox.dataset.index = index;

                // Span ch·ª©a t√™n s√¥ng
                const span = document.createElement('span');
                span.className = 'file-name';
                span.textContent = file.name;

                // Th√™m v√†o DOM
                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);

                // Khi checkbox thay ƒë·ªïi, t·ª± ƒë·ªông load/unload GeoJSON
                checkbox.addEventListener('change', function () {
                    const fileData = dtndqnFiles[index];
                    if (this.checked) {
                        loadDTNDQNFile(fileData); // T·∫£i file s√¥ng
                    } else {
                        unloadDTNDQNFile(fileData); // X√≥a l·ªõp s√¥ng
                    }
                });
            });
        }

        // ==================== T·∫¢I D·ªÆ LI·ªÜU ƒê∆Ø·ªúNG TH·ª¶Y ====================
        // T·∫£i file GeoJSON t·ª´ m√°y ch·ªß v√† hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì
        function loadDTNDQNFile(fileData) {
            // Ki·ªÉm tra file ƒë√£ ƒë∆∞·ª£c t·∫£i ƒë·ªÉ tr√°nh t·∫£i l·∫°i
            if (loadedFiles[fileData.file]) {
                console.log(`File ${fileData.file} ƒë√£ ƒë∆∞·ª£c t·∫£i r·ªìi.`);
                return;
            }

            // Fetch GeoJSON t·ª´ server
            fetch(fileData.file)
                .then(res => res.json())
                .then(data => {
                    // T·∫°o l·ªõp GeoJSON v·ªõi m√†u s·∫Øc ri√™ng
                    const layer = L.geoJSON(data, {
                        style: function () {
                            return { color: fileData.color, weight: 2.5, opacity: 0.7 };
                        },
                        onEachFeature: onEachFeatureHandler // X·ª≠ l√Ω popup cho m·ªói feature
                    }).addTo(map);

                    // L∆∞u reference ƒë·ªÉ qu·∫£n l√Ω
                    dtndqnLayers[fileData.file] = layer;
                    loadedFiles[fileData.file] = true;
                    console.log(`ƒê√£ t·∫£i file ${fileData.file} th√†nh c√¥ng`);

                    // T·ª± ƒë·ªông zoom v√†o d·ªØ li·ªáu v·ª´a t·∫£i
                    zoomToLayer(layer);
                })
                .catch(err => {
                    console.error(`L·ªói khi t·∫£i file ${fileData.file}:`, err);
                    alert(`Kh√¥ng th·ªÉ t·∫£i file ${fileData.name}!`);
                });
        }

        // ==================== H√ÄM X·ª¨ L√ù HI·ªÇN TH·ªä L·ªöPD·ªÆ LI·ªÜU ====================
        // Zoom b·∫£n ƒë·ªì v√†o v√πng d·ªØ li·ªáu c·ªßa m·ªôt l·ªõp
        function zoomToLayer(layer) {
            try {
                const bounds = layer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            } catch (err) {
                console.warn('Kh√¥ng th·ªÉ zoom v√†o layer:', err);
            }
        }

        // X√≥a l·ªõp ƒë∆∞·ªùng th·ªßy kh·ªèi b·∫£n ƒë·ªì
        function unloadDTNDQNFile(fileData) {
            if (dtndqnLayers[fileData.file]) {
                map.removeLayer(dtndqnLayers[fileData.file]);
                delete dtndqnLayers[fileData.file];
                delete loadedFiles[fileData.file];
                console.log(`ƒê√£ x√≥a file ${fileData.file}`);
            }
        }

        // ==================== C·∫§U H√åNH B·∫¢N ƒê·ªí N·ªÄN ====================
        // C√°c l·ªõp b·∫£n ƒë·ªì n·ªÅn t·ª´ Google Maps
        var googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Google Hybrid'
        }).addTo(map);

        var googleRoadmap = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Google Roadmap'
        });

        var googleTerrain = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Google Terrain'
        });

        // Th√™m control ch·ªçn lo·∫°i b·∫£n ƒë·ªì n·ªÅn
        var baseMaps = { "V·ªá tinh": googleHybrid, "Giao th√¥ng": googleRoadmap, "ƒê·ªãa h√¨nh": googleTerrain };
        L.control.layers(baseMaps).addTo(map);

        // ==================== QU·∫¢N L√ù HI·ªÇN TH·ªä NH√ÉN ƒê·ªäA L√ù ====================
        let geoJsonLayer; // Layer ch·ª©a d·ªØ li·ªáu qu·∫≠n huy·ªán
        let labelLayer = L.layerGroup().addTo(map); // Layer ch·ª©a nh√£n t√™n s√¥ng

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã nh√£n s√¥ng khi b·∫£n ƒë·ªì di chuy·ªÉn
        function updateVisibleLabels() {
            labelLayer.clearLayers();
            // Ch·ªâ hi·ªÉn th·ªã nh√£n khi zoom >= 10 ƒë·ªÉ tr√°nh qu√° ƒë√¥ng
            if (map.getZoom() < 10) return;
            const bounds = map.getBounds();

            if (!geoJsonLayer) return;

            geoJsonLayer.eachLayer(function (layer) {
                const props = layer.feature.properties;
                if (!props || !props.name) return;

                // L·∫•y t·ªça ƒë·ªô t·ª´ LineString ho·∫∑c MultiLineString
                let latlngs = [];
                if (layer.feature.geometry.type === 'LineString') {
                    latlngs = layer.getLatLngs();
                } else if (layer.feature.geometry.type === 'MultiLineString') {
                    layer.getLatLngs().forEach(arr => latlngs.push(...arr));
                }

                // Ch·ªâ hi·ªÉn th·ªã nh√£n n·∫øu c√≥ ƒëi·ªÉm trong view hi·ªán t·∫°i
                const visiblePoints = latlngs.filter(p => bounds.contains(p));
                if (visiblePoints.length > 0) {
                    // T√≠nh t√¢m c·ªßa c√°c ƒëi·ªÉm ƒë·ªÉ ƒë·∫∑t nh√£n
                    let latSum = 0, lngSum = 0;
                    visiblePoints.forEach(p => { latSum += p.lat; lngSum += p.lng; });
                    const dynamicCenter = L.latLng(latSum / visiblePoints.length, lngSum / visiblePoints.length);

                    // T·∫°o marker cho nh√£n
                    L.marker(dynamicCenter, {
                        icon: L.divIcon({
                            className: 'road-label-container',
                            html: `<div class="road-label">${props.name}</div>`,
                            iconSize: [8, 20],
                            iconAnchor: [40, 20]
                        }),
                        interactive: false
                    }).addTo(labelLayer);
                }
            });
        }

        // C·∫≠p nh·∫≠t nh√£n khi b·∫£n ƒë·ªì di chuy·ªÉn
        map.on('moveend', updateVisibleLabels);

        // ==================== ƒêI·ªÄU CH·ªàNH OPACITY THEO ZOOM ====================
        // T√≠nh ƒë·ªô trong su·ªët c·ªßa qu·∫≠n huy·ªán t√πy theo m·ª©c zoom
        function calculateOpacity(currentZoom) {
            let baseOpacity = 0.05;
            if (currentZoom <= 15) {
                let diff = 12 - currentZoom;
                return baseOpacity + (diff * 0.1);
            }
            return baseOpacity;
        }

        // C·∫≠p nh·∫≠t opacity khi zoom thay ƒë·ªïi
        map.on('zoomend', function () {
            if (geoJsonLayer) {
                let newOpacity = calculateOpacity(map.getZoom());
                geoJsonLayer.eachLayer(l => l.setStyle({ fillOpacity: newOpacity }));
            }
        });

        // ==================== X·ª¨ L√ù S·ª∞ KI·ªÜN CHO T·ª™NG FEATURE ====================
        // T·∫°o popup v√† x·ª≠ l√Ω hover cho m·ªói feature (qu·∫≠n/huy·ªán)
        function onEachFeatureHandler(feature, layer) {
            if (feature.properties) {
                const p = feature.properties;
                let rows = "";
                // √Ånh x·∫° t√™n tr∆∞·ªùng d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã th√¢n thi·ªán h∆°n
                const labels = {
                    "dan_so": "D√¢n s·ªë",
                    "dtich_km2": "Di·ªán t√≠ch (km¬≤)",
                    "matdo_km2": "M·∫≠t ƒë·ªô"
                };
                // C√°c tr∆∞·ªùng kh√¥ng c·∫ßn hi·ªÉn th·ªã trong popup
                const keysToHide = ['name', 'styleUrl', 'styleHash', 'description', 'stroke', 'fill', 'fill-opacity', 'stroke-opacity', 'stroke-width', 'T√™n ph∆∞·ªùng/x√£', 'ten_xa', 'loai'];

                // X√¢y d·ª±ng b·∫£ng th√¥ng tin
                for (let key in p) {
                    if (!keysToHide.includes(key)) {
                        let displayLabel = labels[key] || key;
                        rows += `<tr><td>${displayLabel}</td><td style="text-align:right">${p[key]}</td></tr>`;
                    }
                }

                // Ti√™u ƒë·ªÅ popup
                let fullTitle = (p.loai ? p.loai + " " : "") + (p.ten_xa || p.name || "Th√¥ng tin");
                layer.bindPopup(`<div class="info-popup"><h3 style="color: #0026FF; border-bottom: 2px solid #FF6A00;">${fullTitle}</h3><table>${rows}</table></div>`);
            }

            // X·ª≠ l√Ω s·ª± ki·ªán mouseover/out ƒë·ªÉ highlight feature
            layer.on({
                mouseover: function (e) {
                    e.target.setStyle({ weight: 7, color: '#FF0000' });
                    e.target.bringToFront();
                },
                mouseout: function (e) {
                    geoJsonLayer.resetStyle(e.target);
                }
            });
        }

        // ==================== T·∫¢I D·ªÆ LI·ªÜU QU·∫¨N HUY·ªÜN ====================
        // T·∫£i file GeoJSON qu·∫≠n/huy·ªán ƒê√† N·∫µng l√†m n·ªÅn
        fetch('QuanHuyen.geojson')
            .then(res => res.json())
            .then(data => {
                geoJsonLayer = L.geoJSON(data, {
                    style: function () {
                        return {
                            fillOpacity: 0.000001, // H·∫ßu nh∆∞ trong su·ªët
                            color: getRandomColor(),
                            weight: 1
                        };
                    },
                    onEachFeature: onEachFeatureHandler
                }).addTo(map);
                updateVisibleLabels();
            });

        // ==================== KH·ªûI T·∫†O B·ªò CH·ªåN S√î NG KHO·∫¢NG H·ª∞A ====================
        // Ch·∫°y initFileSelector khi DOM s·∫µn s√†ng
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initFileSelector);
        } else {
            initFileSelector();
        }

        // ==================== L·∫§Y V·ªä TR√ç GPS C·ª¶A NG∆Ø·ªúI D√ôNG ====================
        // ƒê·ªãnh v·ªã v·ªã tr√≠ hi·ªán t·∫°i c·ªßa ng∆∞·ªùi d√πng
        function findMyState() {
            navigator.geolocation.getCurrentPosition(function (p) {
                const lat = p.coords.latitude, lng = p.coords.longitude;
                currentUserPos = [lat, lng]; // L∆∞u t·ªça ƒë·ªô ƒë·ªÉ chia s·∫ª sau
                // T·∫°o marker cho v·ªã tr√≠ ng∆∞·ªùi d√πng
                L.marker(currentUserPos)
                    .addTo(map)
                    .bindPopup("<b>B·∫°n ƒëang ·ªü ƒë√¢y!</b>")
                    .openPopup();
                // Zoom v√†o v·ªã tr√≠ ng∆∞·ªùi d√πng
                map.setView(currentUserPos, 15);
            });
        }

        // ==================== CHIA S·∫∫ V·ªä TR√ç ====================
        // Chia s·∫ª v·ªã tr√≠ hi·ªán t·∫°i qua nhi·ªÅu c√°ch
        function shareLocation() {
            if (!currentUserPos) {
                alert("Vui l√≤ng nh·∫•n 'V·ªã tr√≠ c·ªßa t√¥i' tr∆∞·ªõc khi chia s·∫ª!");
                return;
            }
            // T·∫°o URL Google Maps cho v·ªã tr√≠ hi·ªán t·∫°i
            const url = `https://www.google.com/maps?q=${currentUserPos[0]},${currentUserPos[1]}`;

            // D√πng Web Share API n·∫øu thi·∫øt b·ªã h·ªó tr·ª£
            if (navigator.share) {
                navigator.share({
                    title: 'V·ªã tr√≠ c·ªßa t√¥i',
                    text: 'V·ªã tr√≠ c·ªßa t√¥i',
                    url: url
                }).catch(err => console.log('L·ªói chia s·∫ª:', err));
            } else {
                // Fallback: copy URL v√†o clipboard
                navigator.clipboard.writeText(url);
                alert("Link v·ªã tr√≠ ƒë√£ ƒë∆∞·ª£c copy v√†o b·ªô nh·ªõ t·∫°m!");
            }
        }

        // ==================== H√ÄM H·ªñ TR·ª¢ ====================
        // T·∫°o m√†u ng·∫´u nhi√™n cho qu·∫≠n huy·ªán
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>
</body>

</html>
